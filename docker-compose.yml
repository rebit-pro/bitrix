services:
    traefik:
        image: traefik:3.3
        command:
            --providers.docker=true
            --providers.docker.exposedByDefault=false
            --entryPoints.http.address=:80
        ports:
            - "80:80"
        networks:
            - traefik-public
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        labels:
            - traefik.enable=true
            - traefik.docker.network=traefik-public
    frontend:
        build:
            context: frontend/docker
            dockerfile: development/nginx/DockerFile
        networks:
            - traefik-public
            - default
        labels:
            - traefik.enable=true
            - traefik.docker.network=traefik-public
            - traefik.http.routers.frontend.rule=Host(`localhost`) || Host(`www.localhost`)
            - traefik.http.routers.frontend.entryPoints=http
            - traefik.http.services.frontend.loadBalancer.server.port=80
            - traefik.http.middlewares.frontend-redirect.redirectRegex.regex=^(https?://)www.localhost/(.*)$$
            - traefik.http.middlewares.frontend-redirect.redirectRegex.replacement=$${1}localhost/$${2}
            - traefik.http.middlewares.frontend-redirect.redirectRegex.permanent=true
            - traefik.http.routers.frontend.middlewares=frontend-redirect
            
    api:
        build: 
            context: api/docker
            dockerfile: development/nginx/DockerFile
        volumes:
            - ./api:/app
        networks:
            - traefik-public
            - default
        labels:
            - traefik.enable=true
            - traefik.docker.network=traefik-public
            - traefik.http.routers.api.rule=Host(`yurkas.localhost`)
            - traefik.http.routers.api.entryPoints=http
            - traefik.http.services.api.loadBalancer.server.port=80

    api-php-fpm:
        build: 
            context: api/docker
            dockerfile: development/php-fpm/DockerFile
        extra_hosts:
            - "host.docker.internal:host-gateway"
        volumes:
            - ./api:/app
        environment:
            APP_DEBUG: 1

    api-php-cli:
        build: 
            context: api/docker
            dockerfile: development/php-cli/DockerFile
        volumes:
            - ./api:/app
        environment:
            APP_DEBUG: 1

    api-mysql:
        image: mysql:8.0
        restart: always
        environment:
            MYSQL_DATABASE: yurkas
            MYSQL_USER: yurkas
            MYSQL_PASSWORD: secrets
            MYSQL_ROOT_PASSWORD: rootpassword
        volumes:
            - api-mysql:/var/lib/mysql
        ports:
            - "33061:3306"

volumes:
    api-mysql:

networks:
    traefik-public:
        name: traefik-public